name: üöÄ Deploy Full Stack App

on:
  push:
    branches:
      - main

jobs:
  # --------------------------
  # 1Ô∏è‚É£ FRONTEND DEPLOY JOB
  # --------------------------
  frontend-deploy:
    name: Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy Frontend via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üé® Pulling latest frontend code..."
            cd /home/ubuntu/HRMS/frontend
            git pull origin main
            npm install
            npm run build
            echo "‚úÖ Frontend deployed successfully."

  # --------------------------
  # 2Ô∏è‚É£ BACKEND DEPLOY JOB
  # --------------------------
  backend-deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: frontend-deploy   # ‚úÖ This makes backend run only AFTER frontend succeeds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üß† Pulling latest backend code..."
            cd /home/ubuntu/HRMS/backend
            git pull origin main
            pip install -r requirements.txt
            echo "üîÅ Restarting backend service..."
            pm2 restart hrms-backend || pm2 start app.py --name hrms-backend
            echo "‚úÖ Backend deployed successfully."
